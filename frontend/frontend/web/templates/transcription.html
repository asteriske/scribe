{% extends "base.html" %}

{% block title %}{{ transcription.title or 'Transcription' }} - Scribe{% endblock %}

{% block content %}
<div class="transcription-detail">
    <div class="transcription-header">
        <h2>{{ transcription.title or 'Untitled' }}</h2>

        {% if transcription.channel %}
        <p class="channel">{{ transcription.channel }}</p>
        {% endif %}

        <div class="meta">
            <span class="status status-{{ transcription.status }}">
                {{ transcription.status }}
            </span>

            {% if transcription.duration_seconds %}
            <span class="duration">
                {{ (transcription.duration_seconds / 60) | round(1) }} minutes
            </span>
            {% endif %}

            {% if transcription.language %}
            <span class="language">{{ transcription.language }}</span>
            {% endif %}

            {% if transcription.word_count %}
            <span class="word-count">{{ transcription.word_count }} words</span>
            {% endif %}
        </div>

        <div class="transcription-tags-section">
            <h3>Tags</h3>
            <div class="tags-display" id="tagsDisplay">
                {% if transcription.to_dict().tags and transcription.to_dict().tags|length > 0 %}
                    {% for tag in transcription.to_dict().tags %}
                        <span class="tag-chip">{{ tag }}</span>
                    {% endfor %}
                {% else %}
                    <span class="no-tags">No tags</span>
                {% endif %}
                <button class="btn-edit-tags" id="editTagsBtn">Edit</button>
            </div>
            <div class="tags-edit" id="tagsEdit" style="display:none">
                <div id="tagInput"></div>
                <button class="btn-save" id="saveTagsBtn">Save</button>
                <button class="btn-cancel" id="cancelTagsBtn">Cancel</button>
            </div>
        </div>
    </div>

    {% if transcription.status == 'completed' %}
    <div class="export-buttons">
        <a href="/api/transcriptions/{{ transcription.id }}/export/json" class="btn">
            üìÑ JSON
        </a>
        <a href="/api/transcriptions/{{ transcription.id }}/export/txt" class="btn">
            üìù TXT
        </a>
        <a href="/api/transcriptions/{{ transcription.id }}/export/srt" class="btn">
            üé¨ SRT
        </a>
    </div>

    <div class="transcription-text">
        <h3>Transcription</h3>
        <div class="segments">
            {% for segment in segments %}
            <div class="segment">
                <span class="timestamp">{{ segment.start | format_time }}</span>
                <span class="text">{{ segment.text }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    {% elif transcription.status == 'failed' %}
    <div class="error-message">
        <h3>Transcription Failed</h3>
        <p>{{ transcription.error_message }}</p>
    </div>

    {% else %}
    <div class="processing-message">
        <h3>Processing...</h3>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ transcription.progress }}%"></div>
        </div>
        <p>{{ transcription.status }} - {{ transcription.progress }}%</p>
    </div>
    {% endif %}

    <div class="actions">
        <a href="/" class="btn">‚Üê Back to Home</a>
        <button onclick="deleteTranscription('{{ transcription.id }}')" class="btn btn-danger">
            üóëÔ∏è Delete
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteTranscription(id) {
    if (confirm('Are you sure you want to delete this transcription?')) {
        fetch(`/api/transcriptions/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Failed to delete transcription');
            }
        });
    }
}

// Tag editing functionality
document.addEventListener('DOMContentLoaded', () => {
    const editBtn = document.getElementById('editTagsBtn');
    const saveBtn = document.getElementById('saveTagsBtn');
    const cancelBtn = document.getElementById('cancelTagsBtn');
    const display = document.getElementById('tagsDisplay');
    const edit = document.getElementById('tagsEdit');
    const tagInputContainer = document.getElementById('tagInput');

    if (!editBtn || !tagInputContainer) return;

    let tagInputInstance = null;

    // Get transcription ID from URL
    const pathParts = window.location.pathname.split('/');
    const transcriptionId = pathParts[pathParts.length - 1];

    // Get current tags from display
    function getCurrentTags() {
        const chips = display.querySelectorAll('.tag-chip');
        return Array.from(chips).map(chip => chip.textContent.trim());
    }

    // Edit button click
    editBtn.addEventListener('click', () => {
        const currentTags = getCurrentTags();

        // Initialize tag input
        if (!tagInputInstance) {
            tagInputInstance = new TagInput(tagInputContainer, currentTags);
        } else {
            tagInputInstance.setTags(currentTags);
        }

        // Toggle visibility
        display.style.display = 'none';
        edit.style.display = 'block';
    });

    // Save button click
    saveBtn.addEventListener('click', async () => {
        if (!tagInputInstance) return;

        const tags = tagInputInstance.getTags();

        try {
            const response = await fetch(`/api/transcriptions/${transcriptionId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tags })
            });

            if (!response.ok) {
                throw new Error('Failed to update tags');
            }

            // Update display without reloading page
            const data = await response.json();
            updateTagsDisplay(data.tags);

            // Toggle visibility
            display.style.display = 'flex';
            edit.style.display = 'none';

        } catch (error) {
            console.error('Error saving tags:', error);
            alert('Failed to update tags. Please try again.');
        }
    });

    // Cancel button click
    cancelBtn.addEventListener('click', () => {
        display.style.display = 'flex';
        edit.style.display = 'none';
    });

    /**
     * Update tags display after save
     */
    function updateTagsDisplay(tags) {
        // Clear existing chips
        const chips = display.querySelectorAll('.tag-chip, .no-tags');
        chips.forEach(chip => chip.remove());

        // Add new chips
        if (tags && tags.length > 0) {
            tags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.textContent = tag;
                display.insertBefore(chip, editBtn);
            });
        } else {
            const noTags = document.createElement('span');
            noTags.className = 'no-tags';
            noTags.textContent = 'No tags';
            display.insertBefore(noTags, editBtn);
        }
    }
});
</script>
{% endblock %}
